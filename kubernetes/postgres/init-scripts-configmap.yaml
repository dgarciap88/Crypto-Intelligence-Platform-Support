apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: crypto-intel
  labels:
    app: postgres
    component: database
data:
  00_init.sql: |
    -- Enable required extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pg_trgm";
    CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";
    
    -- Create tables (from create_tables.sql)
    -- NOTE: For production, consider using a migration tool like Flyway or Liquibase
    --       This is a simplified version for quick setup
    
    CREATE TABLE IF NOT EXISTS projects (
        project_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        name VARCHAR(255) NOT NULL UNIQUE,
        description TEXT,
        website_url VARCHAR(500),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    CREATE TABLE IF NOT EXISTS sources (
        source_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        project_id UUID REFERENCES projects(project_id) ON DELETE CASCADE,
        source_type VARCHAR(50) NOT NULL,
        identifier VARCHAR(500) NOT NULL,
        metadata JSONB,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(project_id, source_type, identifier)
    );
    
    CREATE TABLE IF NOT EXISTS raw_events (
        event_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        source_id UUID REFERENCES sources(source_id) ON DELETE CASCADE,
        event_type VARCHAR(100) NOT NULL,
        event_timestamp TIMESTAMP NOT NULL,
        payload JSONB NOT NULL,
        ingested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        external_id VARCHAR(255),
        UNIQUE(source_id, external_id)
    );
    
    CREATE TABLE IF NOT EXISTS normalized_events (
        normalized_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        raw_event_id UUID REFERENCES raw_events(event_id) ON DELETE CASCADE,
        project_id UUID REFERENCES projects(project_id) ON DELETE CASCADE,
        entity_type VARCHAR(100) NOT NULL,
        entity_id VARCHAR(500) NOT NULL,
        title TEXT NOT NULL,
        description TEXT,
        event_timestamp TIMESTAMP NOT NULL,
        metadata JSONB,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(raw_event_id, entity_type, entity_id)
    );
    
    CREATE TABLE IF NOT EXISTS ai_insights (
        insight_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        project_id UUID REFERENCES projects(project_id) ON DELETE CASCADE,
        insight_type VARCHAR(100) NOT NULL,
        title TEXT NOT NULL,
        content TEXT NOT NULL,
        confidence DECIMAL(3,2),
        source_event_ids UUID[],
        time_range_start TIMESTAMP,
        time_range_end TIMESTAMP,
        metadata JSONB,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Create indexes
    CREATE INDEX IF NOT EXISTS idx_sources_project_id ON sources(project_id);
    CREATE INDEX IF NOT EXISTS idx_sources_type ON sources(source_type);
    CREATE INDEX IF NOT EXISTS idx_raw_events_source_id ON raw_events(source_id);
    CREATE INDEX IF NOT EXISTS idx_raw_events_timestamp ON raw_events(event_timestamp);
    CREATE INDEX IF NOT EXISTS idx_raw_events_type ON raw_events(event_type);
    CREATE INDEX IF NOT EXISTS idx_raw_events_external_id ON raw_events(external_id);
    CREATE INDEX IF NOT EXISTS idx_raw_events_payload_gin ON raw_events USING gin(payload);
    CREATE INDEX IF NOT EXISTS idx_normalized_project_id ON normalized_events(project_id);
    CREATE INDEX IF NOT EXISTS idx_normalized_entity ON normalized_events(entity_type, entity_id);
    CREATE INDEX IF NOT EXISTS idx_normalized_timestamp ON normalized_events(event_timestamp);
    CREATE INDEX IF NOT EXISTS idx_normalized_metadata_gin ON normalized_events USING gin(metadata);
    CREATE INDEX IF NOT EXISTS idx_insights_project_id ON ai_insights(project_id);
    CREATE INDEX IF NOT EXISTS idx_insights_type ON ai_insights(insight_type);
    CREATE INDEX IF NOT EXISTS idx_insights_time_range ON ai_insights(time_range_start, time_range_end);
    CREATE INDEX IF NOT EXISTS idx_insights_metadata_gin ON ai_insights USING gin(metadata);
